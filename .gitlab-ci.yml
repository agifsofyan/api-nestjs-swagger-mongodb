image: docker:latest

services: 
    - docker:dind

stages:
    - build

docker-build:
    stage: build
    before_script:
        - echo $CI_BUILD_TOKEN | docker login -u "$DOCKER_USER" --password "$DOCKER_PASS"
        - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
    script:
        - sudo docker image prune -f
        - sudo docker-compose -f docker-compose.yml build --no-cache
        - docker build --pull -t "$DOCKER_IMAGE" .
        - docker push "$DOCKER_IMAGE"
    only:
        - master
